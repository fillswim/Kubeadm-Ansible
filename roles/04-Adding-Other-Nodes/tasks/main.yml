---
# tasks file for 04-Adding-Other-Nodes

# =============================================================================
#              Получить токены для добавления нод (на 1-й мастер ноде)
# =============================================================================

- name: Блок на получение токенов для добавления нод (на 1-й мастер ноде)
  become: true
  when:
    - inventory_hostname == groups['k8s_masters'][0]
  block:

    # =========================================================================
    #          Получить список всех добавленных нод в кластере
    # =========================================================================

    - name: Get all added nodes
      ignore_errors: true
      changed_when: false
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get nodes --no-headers | awk '{print $1}'
      register: all_added_nodes

    - name: Create variable all_added_nodes
      ansible.builtin.set_fact:
        all_added_nodes: "{{ all_added_nodes.stdout }}"

    - name: Show all_added_nodes
      ansible.builtin.debug:
        var: all_added_nodes

    # =========================================================================
    #                           Get join_path
    # =========================================================================

    - name: Get join_path
      changed_when: false
      ansible.builtin.shell: |
        set -o pipefail
        kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}' | cut -c9-
      register: join_path

    - name: Create variable join_path
      ansible.builtin.set_fact:
        join_path: "{{ join_path.stdout }}"

    - name: Show join_path
      ansible.builtin.debug:
        var: join_path

    # =========================================================================
    #                           Get join_token
    # =========================================================================

    - name: Get join_token
      ansible.builtin.shell: |
        set -o pipefail
        kubeadm token create
      register: join_token

    - name: Create variable join_token
      ansible.builtin.set_fact:
        join_token: "{{ join_token.stdout }}"

    - name: Show join_token
      ansible.builtin.debug:
        var: join_token

    # =========================================================================
    #                          Get ca_cert_hash
    # =========================================================================

    - name: Get ca_cert_hash
      ansible.builtin.shell: |
        set -o pipefail
        openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
        openssl rsa -pubin -outform der 2>/dev/null | \
        openssl dgst -sha256 -hex | sed 's/^.* //'
      register: ca_cert_hash

    - name: Create variable ca_cert_hash
      ansible.builtin.set_fact:
        ca_cert_hash: "{{ ca_cert_hash.stdout }}"

    - name: Show ca_cert_hash
      ansible.builtin.debug:
        var: ca_cert_hash

    # =========================================================================
    #                          Get Get certificate_key
    # =========================================================================

    - name: Get certificate_key
      ansible.builtin.shell: |
        set -o pipefail
        kubeadm init phase upload-certs --upload-certs | tail -1
      register: certificate_key

    - name: Create variable certificate_key
      ansible.builtin.set_fact:
        certificate_key: "{{ certificate_key.stdout }}"

    - name: Show certificate_key
      ansible.builtin.debug:
        var: certificate_key


# =============================================================================
#                              Блок добавления нод
# =============================================================================


- name: Блок на добавление нод
  become: true
  when:
    - inventory_hostname not in hostvars[groups['k8s_masters'][0]].all_added_nodes
  block:

    # =========================================================================
    #                              Блок добавления master-нод
    # =========================================================================

    - name: Блок на добавление мастер-нод
      become: true
      when:
        - inventory_hostname in groups['k8s_masters'][1:]
      block:

        - name: Checking that the node is already attached
          ansible.builtin.stat:
            path: "/etc/kubernetes/pki/ca.key"
          register: kubeadm_ca

        - name: Join master-node {{ inventory_hostname }}
          when: not kubeadm_ca.stat.exists
          ansible.builtin.shell:
            cmd: |
              kubeadm join {{ hostvars[groups['k8s_masters'][0]].join_path }} \
              --token {{ hostvars[groups['k8s_masters'][0]].join_token }} \
              --discovery-token-ca-cert-hash sha256:{{ hostvars[groups['k8s_masters'][0]].ca_cert_hash }} \
              --certificate-key {{ hostvars[groups['k8s_masters'][0]].certificate_key }} \
              --node-name {{ inventory_hostname }} \
              --control-plane

        - name: Создание папки /root/.kube
          ansible.builtin.file:
            path: /root/.kube
            state: directory
            owner: root
            group: root
            mode: "0775"

        - name: Copy /etc/kubernetes/admin.conf to /root/.kube/config
          become: true
          ansible.builtin.copy:
            src: /etc/kubernetes/admin.conf
            dest: /root/.kube/config
            remote_src: true
            owner: root
            group: root
            mode: "0600"

        - name: Pause for 30 seconds
          ansible.builtin.pause:
            seconds: 30

    # =========================================================================
    #                         Блок добавления worker-нод
    # =========================================================================

    - name: Блок на добавление worker-нод
      become: true
      when:
        - inventory_hostname in groups['k8s_workers']
      block:

        - name: Checking that the node is already attached
          ansible.builtin.stat:
            path: "/etc/kubernetes/pki/ca.key"
          register: kubeadm_ca

        - name: Join worker-node {{ inventory_hostname }}
          when: not kubeadm_ca.stat.exists
          ansible.builtin.shell:
            cmd: |
              kubeadm join {{ hostvars[groups['k8s_masters'][0]].join_path }} \
              --token {{ hostvars[groups['k8s_masters'][0]].join_token }} \
              --discovery-token-ca-cert-hash sha256:{{ hostvars[groups['k8s_masters'][0]].ca_cert_hash }} \
              --node-name {{ inventory_hostname }}
